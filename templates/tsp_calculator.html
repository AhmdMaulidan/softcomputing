{% extends 'base.html' %}

{% block title %}TSP Genetic Algorithm - {{ super() }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title text-center mb-0">Traveling Salesperson Problem (TSP) with Genetic Algorithm</h2>
        </div>
        <div class="card-body">
            {% if error %}
            <div class="alert alert-danger" role="alert">
                {{ error }}
            </div>
            {% endif %}

            <form method="POST" id="tsp-form">
                <div class="row g-4">
                    <!-- Left Column: Inputs & Parameters -->
                    <div class="col-lg-6">
                        <div class="d-flex flex-column h-100">
                            <h4>Input &amp; Parameters</h4>

                            <input type="hidden" id="dist_matrix_json" name="dist_matrix_json" value="{{ form_data.dist_matrix_json }}">

                            <div class="row g-3 align-items-end mb-3">
                                <div class="col-md-7">
                                    <label for="city_names" class="form-label">City Names (comma-separated)</label>
                                    <input type="text" class="form-control" id="city_names" name="city_names" value="{{ form_data.get('city_names', 'A, B, C, D') }}" placeholder="e.g., A, B, C, D">
                                </div>
                                <div class="col-md-5">
                                    <button type="button" id="generate-matrix-btn" class="btn btn-secondary w-100">Generate Grid</button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Distance Matrix Input</label>
                                <div id="matrix-input-grid" class="table-responsive">
                                    <p class="text-muted small">Enter city names and click "Generate Grid" to build the matrix.</p>
                                </div>
                            </div>

                            <hr>
                            <h5>Genetic Algorithm Parameters</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="pop_size" class="form-label">Population Size</label>
                                    <input type="number" class="form-control" id="pop_size" name="pop_size" value="{{ form_data.get('pop_size', 250) }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="generations" class="form-label">Generations</label>
                                    <input type="number" class="form-control" id="generations" name="generations" value="{{ form_data.get('generations', 200) }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="pc" class="form-label">Crossover Prob. (PC)</label>
                                    <input type="number" step="0.01" max="1" min="0" class="form-control" id="pc" name="pc" value="{{ form_data.get('pc', 0.8) }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="pm" class="form-label">Mutation Prob. (PM)</label>
                                    <input type="number" step="0.01" max="1" min="0" class="form-control" id="pm" name="pm" value="{{ form_data.get('pm', 0.2) }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="tournament_k" class="form-label">Tournament Size</label>
                                    <input type="number" class="form-control" id="tournament_k" name="tournament_k" value="{{ form_data.get('tournament_k', 5) }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="elite_size" class="form-label">Elite Size</label>
                                    <input type="number" class="form-control" id="elite_size" name="elite_size" value="{{ form_data.get('elite_size', 1) }}">
                                </div>
                            </div>
                            
                            <div class="mt-auto pt-3">
                                <button type="submit" class="btn btn-primary w-100 btn-lg">Find Best Route</button>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Results -->
                    <div class="col-lg-6">
                        <h4>Results</h4>
                        {% if result %}
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Optimal Solution Found</h5>
                                <div class="mb-3">
                                    <strong>Best Route:</strong>
                                    <div class="fs-6 text-break">
                                        <span class="badge bg-success-subtle border border-success-subtle text-success-emphasis rounded-pill">{{ result.best_route_named | join(' &rarr; ') | safe }} &rarr; {{ result.best_route_named[0] }}</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <strong>Total Distance:</strong>
                                    <p class="fs-4 fw-bold mb-1">{{ '%.4f' | format(result.best_distance) }}</p>
                                </div>
                                
                                <hr>
                                
                                <h6 class="mt-3">Convergence Graph</h6>
                                <canvas id="convergenceChart" style="max-height: 250px;"></canvas>
                            </div>
                        </div>
                        {% else %}
                        <div class="card h-100 d-flex align-items-center justify-content-center bg-body-tertiary">
                           <div class="text-center p-5">
                                <p class="text-muted">Results will be displayed here after calculation.</p>
                           </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

{# This script handles the dynamic grid generation #}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-matrix-btn');
    const matrixGrid = document.getElementById('matrix-input-grid');
    const cityNamesInput = document.getElementById('city_names');
    const tspForm = document.getElementById('tsp-form');
    const distMatrixJsonInput = document.getElementById('dist_matrix_json');

    function generateMatrix() {
        const cityNames = cityNamesInput.value.split(',').map(s => s.trim()).filter(Boolean);
        const numCities = cityNames.length;

        if (numCities === 0) {
            matrixGrid.innerHTML = '<p class="text-muted small">Please enter city names first.</p>';
            return;
        }

        let table = '<table class="table table-bordered text-center table-sm">';
        table += '<thead><tr><th style="width: 40px;">&nbsp;</th>';
        cityNames.forEach(name => { table += `<th>${name}</th>`; });
        table += '</tr></thead>';

        table += '<tbody>';
        for (let i = 0; i < numCities; i++) {
            table += `<tr><th>${cityNames[i]}</th>`;
            for (let j = 0; j < numCities; j++) {
                const value = (i === j) ? '0' : '';
                const disabled = (i === j) ? 'readonly' : '';
                table += `<td><input type="number" class="form-control form-control-sm matrix-cell" value="${value}" ${disabled} data-row="${i}" data-col="${j}" style="min-width: 60px;"></td>`;
            }
            table += '</tr>';
        }
        table += '</tbody></table>';
        matrixGrid.innerHTML = table;
    }

    function serializeMatrix() {
        const cityNames = cityNamesInput.value.split(',').map(s => s.trim()).filter(Boolean);
        const numCities = cityNames.length;
        if (numCities === 0) {
            distMatrixJsonInput.value = '[]';
            return true;
        }

        let matrix = Array(numCities).fill(null).map(() => Array(numCities).fill(0));
        
        document.querySelectorAll('.matrix-cell').forEach(cell => {
            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.col, 10);
            if (row < numCities && col < numCities) {
                const value = parseFloat(cell.value);
                matrix[row][col] = isNaN(value) ? 0 : value;
            }
        });

        distMatrixJsonInput.value = JSON.stringify(matrix, null, 2);
        return true;
    }
    
    generateBtn.addEventListener('click', generateMatrix);
    cityNamesInput.addEventListener('blur', generateMatrix);
    tspForm.addEventListener('submit', serializeMatrix);
    
    if (cityNamesInput.value) {
        generateMatrix();
        if (distMatrixJsonInput.value) {
            try {
                const oldMatrix = JSON.parse(distMatrixJsonInput.value);
                if (Array.isArray(oldMatrix)) {
                    document.querySelectorAll('.matrix-cell').forEach(cell => {
                        const row = parseInt(cell.dataset.row, 10);
                        const col = parseInt(cell.dataset.col, 10);
                        if (oldMatrix[row] && typeof oldMatrix[row][col] !== 'undefined') {
                            cell.value = oldMatrix[row][col];
                        }
                    });
                }
            } catch (e) {
                console.error("Could not parse old distance matrix:", e);
            }
        }
    }
});
</script>

{# FIX: These scripts for the chart are only loaded if there is a result #}
{% if result %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chartCanvas = document.getElementById('convergenceChart');
    if (!chartCanvas) return; // Exit if canvas not found

    const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
    const textColor = isDarkMode ? '#dee2e6' : '#212529';

    const ctx = chartCanvas.getContext('2d');
    const history = {{ result.history | tojson }};
    const generations = Array.from({length: history.length}, (_, i) => i + 1);

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: generations,
            datasets: [{
                label: 'Best Distance per Generation',
                data: history,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                fill: true,
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Algorithm Convergence',
                    color: textColor
                },
                legend: {
                    labels: {
                        color: textColor
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Generation',
                        color: textColor
                    },
                    grid: {
                        color: gridColor
                    },
                    ticks: {
                        color: textColor
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Distance',
                        color: textColor
                    },
                    grid: {
                        color: gridColor
                    },
                    ticks: {
                        color: textColor
                    }
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}
